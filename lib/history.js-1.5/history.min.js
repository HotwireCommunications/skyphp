/**
 * History.js HTML5 Support
 * @author Benjamin Arthur Lupton <contact@balupton.com>
 * @copyright 2010-2011 Benjamin Arthur Lupton <contact@balupton.com>
 * @license New BSD License <http://creativecommons.org/licenses/BSD/>
 */(function(e,g){e.History=e.History||{};e._History=e._History||{};var b=e.console||g,a=e.document,c=e._History,d=e.History,f=e.history;if(typeof d.initHtml5!=="undefined"){throw new Error("History.js HTML5 Support has already been loaded...")}d.initHtml5=function(){if(typeof d.Adapter==="undefined"){return false}d.options={hashChangeCheckerDelay:100,busyDelay:250};d.debug=function(){if((d.debug.enable||false)){d.log.apply(d,arguments)}};d.debug.enable=false;d.log=function(){var p=(typeof b!=="undefined"),j=a.getElementById("log"),o=("\n"+arguments[0]+"\n"),m;if(p){var k=Array.prototype.slice.call(arguments),o=k.shift();if(typeof b.debug!=="undefined"){b.debug.apply(b,[o,k])}else{b.log.apply(b,[o,k])}}for(m=1,n=arguments.length;m<n;++m){var h=arguments[m];if(typeof h==="object"&&typeof JSON!=="undefined"){try{h=JSON.stringify(h)}catch(l){}}o+="\n"+h+"\n"}if(j){j.value+=o+"\n-----\n";j.scrollTop=j.scrollHeight-j.clientHeight}else{if(!p){alert(o)}}return true};c.getInternetExplorerMajorVersion=function(){var h=c.getInternetExplorerMajorVersion.cached=(typeof c.getInternetExplorerMajorVersion.cached!=="undefined")?c.getInternetExplorerMajorVersion.cached:(function(){var k,i=3,l=a.createElement("div"),j=l.getElementsByTagName("i");while(l.innerHTML="<!--[if gt IE "+(++i)+"]><i></i><![endif]-->",j[0]){}return i>4?i:k})();return h};c.isInternetExplorer=function(){var h=c.isInternetExplorer.cached=(typeof c.isInternetExplorer.cached!=="undefined")?c.isInternetExplorer.cached:(c.getInternetExplorerMajorVersion()!==0);return h};d.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState)};c.isEmptyObject=function(i){for(var h in i){if(!this.hasOwnProperty(h)){continue}return false}return true};c.cloneObject=function(j){var i,h;if(j){i=JSON.stringify(j);h=JSON.parse(i)}else{h={}}return h};d.contractUrl=function(h){h=d.expandUrl(h);var i=a.location.protocol+"//"+(a.location.hostname||a.location.host);if(a.location.port||false){i+=":"+a.location.port}i+="/";h=h.replace(i,"/");return h};d.expandUrl=function(i){i=i||"";if(/[a-z]+\:\/\//.test(i)){}else{if(i.length===0||i.substring(0,1)==="?"){var o=a.location.href.replace(/[#\?].*/,"");i=o+i}else{var h=a.getElementsByTagName("base"),k=null,j="";if(h.length===1){k=h[0];j=k.href;if(j[j.length-1]!=="/"){j+="/"}i=j+i.replace(/^\//,"")}else{if(i.substring(0,1)==="."){var l=a.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,"");if(l[l.length-1]!=="/"){l+="/"}i=l+i}else{var m=a.location.protocol+"//"+(a.location.hostname||a.location.host);if(a.location.port||false){m+=":"+a.location.port}m+="/";i=m+i.replace(/^\//,"")}}}}return i};d.expandState=function(h){h=h||{};var i={data:h.data||{},url:d.expandUrl(h.url||""),title:h.title||""};i.data.title=i.data.title||i.title;i.data.url=i.data.url||i.url;return i};d.createStateObject=function(j,k,i){var h={data:j,title:k,url:i};h=d.expandState(h);return h};d.expandHash=function(o){var i=null;try{i=JSON.parse(o)}catch(l){var m=/(.*)\/uid=([0-9]+)$/.exec(o),j=m?(m[1]||o):o,k=m?String(m[2]||""):"";if(k){i=c.getStateByUid(k)||null}if(!i&&/\//.test(o)){var h=d.expandUrl(o);i=d.createStateObject(null,null,h)}else{}}i=i?d.expandState(i):null;return i};d.contractState=function(i){if(!i){return null}var k=null,h=c.cloneObject(i);if(h){h.data=h.data||{};delete h.data.title;delete h.data.url;if(c.isEmptyObject(h)&&!h.title){k=d.contractUrl(h.url)}else{k=JSON.stringify(h);var j;if(typeof c.hashesToUids[k]!=="undefined"){j=c.hashesToUids[k]}else{while(true){j=String(Math.floor(Math.random()*1000));if(typeof c.uidsToStates[j]==="undefined"){break}}}c.hashesToUids[k]=j;c.uidsToStates[j]=h;k=d.contractUrl(h.url)+"/uid="+j}}return k};c.uidsToStates={};c.hashesToUids={};c.getStateByUid=function(i){i=String(i);var h=c.uidsToStates[i]||g;return h};c.statesByUrl={};c.duplicateStateUrls={};c.statesByHash={};c.savedStates=[];d.getState=function(){return c.getStateByIndex()};d.getStateHash=function(){return d.contractState(d.getState())};c.getStateByUrl=function(i){var h=c.statesByUrl[i]||g;return h};c.getStateByHash=function(h){var i=c.statesByHash[h]||g;return i};c.storeState=function(k){var i=d.contractState(k),h=c.getStateByUrl(k.url);if(typeof h!=="undefined"){var j=d.contractState(h);if(j!==i){c.duplicateStateUrls[k.url]=true}}c.statesByUrl[k.url]=c.statesByHash[i]=k;return true};c.isLastState=function(k){var i=d.contractState(k),j=d.getStateHash();var h=c.savedStates.length&&i===j;return h};c.saveState=function(h){if(c.isLastState(h)){return false}c.savedStates.push(h);return true};c.getStateByIndex=function(i){var h=null;if(typeof i==="undefined"){h=c.savedStates[c.savedStates.length-1]}else{if(i<0){h=c.savedStates[c.savedStates.length+i]}else{h=c.savedStates[i]}}return h};c.stateUrlExists=function(i){var h=typeof c.statesByUrl[i]!=="undefined";return h};c.urlDuplicateExists=function(i){var h=typeof c.duplicateStateUrls[i]!=="undefined";return h};d.getHash=function(){var h=c.unescapeHash(a.location.hash);return h};c.unescapeHash=function(i){var h=c.normalizeHash(i);if(/[\%]/.test(h)){h=unescape(h)}return h};c.normalizeHash=function(i){var h=i.replace(/[^#]*#/,"").replace(/#.*/,"");return h};d.setHash=function(j,i){if(i!==false&&d.busy()){d.debug("History.setHash: we must wait",arguments);d.pushQueue({scope:d,callback:d.setHash,args:arguments,queue:i});return false}var h=c.escapeHash(j);d.debug("History.setHash",this,arguments,"hash:",j,"adjustedHash:",h,"oldHash:",a.location.hash);d.busy(true);a.location.hash=h;return j};c.escapeHash=function(i){var h=c.normalizeHash(i);if(/[^a-zA-Z0-9\/\-\_\%\.]/.test(h)){h=escape(h)}return h};d.extractHashFromUrl=function(h){var i=String(h).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");i=c.unescapeHash(i);return i};d.isTraditionalAnchor=function(h){var j=d.extractHashFromUrl(h),i=a.getElementById(j),k=typeof i!=="undefined";return k};d.queues=[];d.busy=function(i){d.debug("History.busy: called: changing ["+(d.busy.flag||false)+"] to ["+(i||false)+"]",d.queues);if(typeof i!=="undefined"){d.busy.flag=i}else{if(typeof d.busy.flag==="undefined"){d.busy.flag=false}}if(!d.busy.flag){clearTimeout(d.busy.timeout);var h=function(){if(d.busy.flag){return}for(var k=d.queues.length-1;k>=0;--k){var j=d.queues[k];if(j.length===0){continue}var l=j.shift();d.debug("History.busy: firing",l);d.fireQueueItem(l);d.busy.timeout=setTimeout(h,d.options.busyDelay)}};d.busy.timeout=setTimeout(h,d.options.busyDelay)}return d.busy.flag};d.fireQueueItem=function(h){return h.callback.apply(h.scope||d,h.args||[])};d.pushQueue=function(h){d.debug("History.pushQueue: called",arguments);d.queues[h.queue||0]=d.queues[h.queue||0]||[];d.queues[h.queue||0].push(h);return true};d.queue=function(i,h){if(typeof i==="function"){i={callback:i}}if(typeof h!=="undefined"){i.queue=h}if(d.busy()){d.pushQueue(i)}else{d.fireQueueItem(i)}return true};d.back=function(h){d.debug("History.back: called",arguments);if(h!==false&&d.busy()){d.debug("History.back: we must wait",arguments);d.pushQueue({scope:d,callback:d.back,args:arguments,queue:h});return false}d.busy(true);if(d.emulated.hashChange&&c.isInternetExplorer()){var i=d.getHash();setTimeout(function(){var j=d.getHash();if(j===i){d.debug("History.back: trying again");return d.back(false)}return true},d.options.hashChangeCheckerDelay*5)}f.go(-1);return true};d.forward=function(h){d.debug("History.forward: called",arguments);if(h!==false&&d.busy()){d.debug("History.forward: we must wait",arguments);d.pushQueue({scope:d,callback:d.forward,args:arguments,queue:h});return false}d.busy(true);if(d.emulated.hashChange&&c.isInternetExplorer()){var i=d.getHash();setTimeout(function(){var j=d.getHash();if(j===i){d.debug("History.forward: trying again");return d.forward(false)}return true},d.options.hashChangeCheckerDelay*5)}f.go(1);return true};d.go=function(j,h){d.debug("History.go: called",arguments);if(j>0){for(var k=1;k<=j;++k){d.forward(h)}}else{if(j<0){for(var k=-1;k>=j;--k){d.back(h)}}else{throw new Error("History.go: History.go requires a positive or negative integer passed.")}}return true};if(!d.emulated.pushState){c.onPopState=function(h){d.debug("_History.onPopState",this,arguments);var m=unescape(d.getHash());if(m){var i=d.expandHash(m);if(i){d.debug("_History.onPopState: state anchor",m,i);d.replaceState(i.data,i.tite,i.url,false)}else{d.debug("_History.onPopState: traditional anchor",m);d.Adapter.trigger(e,"anchorchange");d.busy(false)}return false}var j=null,k={},p=null,r=null,o=null;h=h||{};if(typeof h.state==="undefined"){if(typeof h.originalEvent!=="undefined"&&typeof h.originalEvent.state!=="undefined"){h.state=h.originalEvent.state}else{if(typeof h.event!=="undefined"&&typeof h.event.state!=="undefined"){h.state=h.event.state}}}if(h.state===null){k=h.state}else{if(typeof h.state!=="undefined"){var s=d.expandUrl(a.location.href),l=c.getStateByUrl(s),q=c.urlDuplicateExists(s);if(typeof l!=="undefined"&&!q){k=l.data}else{k=h.state}}else{var s=d.expandUrl(a.location.href),l=c.getStateByUrl(s);if(l&&s==l.url){k=l.data}else{throw new Error("Unknown state")}}}k=(typeof k!=="object"||k===null)?{}:k;p=k.title||"",r=k.url||a.location.href,o=d.createStateObject(k,p,r);if(c.isLastState(o)){d.debug("_History.onPopState: no change",o,c.savedStates);d.busy(false);return false}d.debug("_History.onPopState","newState:",o,"oldState:",c.getStateByUrl(d.expandUrl(a.location.href)),"duplicateExists:",c.urlDuplicateExists(d.expandUrl(a.location.href)));c.storeState(o);c.saveState(o);if(o.title){a.title=o.title}d.Adapter.trigger(e,"statechange");d.busy(false);return true};d.Adapter.bind(e,"popstate",c.onPopState);d.pushState=function(j,l,i,h){if(d.extractHashFromUrl(i)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(h!==false&&d.busy()){d.debug("History.pushState: we must wait",arguments);d.pushQueue({scope:d,callback:d.pushState,args:arguments,queue:h});return false}d.busy(true);var k=d.createStateObject(j,l,i);c.storeState(k);f.pushState(k.data,k.title,k.url);d.Adapter.trigger(e,"popstate");return true};d.replaceState=function(j,l,i,h){if(d.extractHashFromUrl(i)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(h!==false&&d.busy()){d.debug("History.replaceState: we must wait",arguments);d.pushQueue({scope:d,callback:d.replaceState,args:arguments,queue:h});return false}d.busy(true);var k=d.createStateObject(j,l,i);c.storeState(k);f.replaceState(k.data,k.title,k.url);d.Adapter.trigger(e,"popstate");return true};if(navigator.vendor==="Apple Computer, Inc."){d.Adapter.onDomLoad(function(){d.debug("Safari Initial State Change Fix");var h=d.createStateObject({},"",a.location.href);d.pushState(h.data,h.title,h.url)});d.Adapter.bind(e,"hashchange",function(){d.Adapter.trigger(e,"popstate")})}}};d.initHtml5()})(window);