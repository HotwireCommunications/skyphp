/**
 * History.js HTML4 Support
 * Depends on the HTML5 Support
 * @author Benjamin Arthur Lupton <contact@balupton.com>
 * @copyright 2010-2011 Benjamin Arthur Lupton <contact@balupton.com>
 * @license New BSD License <http://creativecommons.org/licenses/BSD/>
 */(function(d,e){d.History=d.History||{};d._History=d._History||{};var a=d.document,b=d._History,c=d.History;if(typeof c.initHtml4!=="undefined"){throw new Error("History.js HTML4 Support has already been loaded...")}c.initHtml4=function(){if(typeof c.initHtml5==="undefined"||typeof c.Adapter==="undefined"){return false}b.getInternetExplorerMajorVersion=function(){var f=b.getInternetExplorerMajorVersion.cached=(typeof b.getInternetExplorerMajorVersion.cached!=="undefined")?b.getInternetExplorerMajorVersion.cached:(function(){var i,g=3,j=a.createElement("div"),h=j.getElementsByTagName("i");while(j.innerHTML="<!--[if gt IE "+(++g)+"]><i></i><![endif]-->",h[0]){}return g>4?g:i})();return f};b.isInternetExplorer=function(){var f=b.isInternetExplorer.cached=(typeof b.isInternetExplorer.cached!=="undefined")?b.isInternetExplorer.cached:(b.getInternetExplorerMajorVersion()!==0);return f};c.emulated.hashChange=Boolean(!("onhashchange" in d||"onhashchange" in a)||(b.isInternetExplorer()&&b.getInternetExplorerMajorVersion()<8));b.savedHashes=[];b.isLastHash=function(f){var h=b.getHashByIndex();var g=f===h;return g};b.saveHash=function(f){if(b.isLastHash(f)){return false}b.savedHashes.push(f);return true};b.getHashByIndex=function(f){var g=null;if(typeof f==="undefined"){g=b.savedHashes[b.savedHashes.length-1]}else{if(f<0){g=b.savedHashes[b.savedHashes.length+f]}else{g=b.savedHashes[f]}}return g};b.stateHashExists=function(f){var g=typeof b.statesByHash[f]!=="undefined";return g};b.discardedHashes={};b.discardedStates={};b.discardState=function(j,f,i){c.debug("History.discardState",this,arguments);var g=c.contractState(j);var h={discardedState:j,backState:i,forwardState:f};b.discardedStates[g]=h;return true};b.discardHash=function(g,f,i){c.debug("History.discardState",this,arguments);var h={discardedHash:g,backState:i,forwardState:f};b.discardedHashes[g]=h;return true};b.discardedState=function(f){var h=c.contractState(f);var g=b.discardedStates[h]||false;return g};b.discardedHash=function(g){var f=b.discardedHashes[g]||false;return f};b.recycleState=function(f){c.debug("History.recycleState",this,arguments);var g=c.contractState(f);if(b.discardedState(f)){delete b.discardedStates[g]}return true};if(c.emulated.hashChange){c.Adapter.onDomLoad(function(){b.checkerFunction=null;if(b.isInternetExplorer()){var j="historyjs-iframe",g=a.createElement("iframe");g.setAttribute("id",j);g.style.display="none";a.body.appendChild(g);g.contentWindow.document.open();g.contentWindow.document.close();var f=null,h=null,i=false;b.checkerFunction=function(){if(i){c.debug("hashchange.checker: checker is running");return false}i=true;var l=c.getHash(),k=b.unescapeHash(g.contentWindow.document.location.hash);if(l!==f){f=l;if(k!==l){c.debug("hashchange.checker: iframe hash change","documentHash (new):",l,"iframeHash (old):",k);h=k=l;g.contentWindow.document.open();g.contentWindow.document.close();g.contentWindow.document.location.hash=b.escapeHash(l)}c.Adapter.trigger(d,"hashchange")}else{if(k!==h){c.debug("hashchange.checker: iframe hash out of sync","iframeHash (new):",k,"documentHash (old):",l);h=k;c.setHash(k,false)}}i=false;return true}}else{var f=null;b.checkerFunction=function(){var k=c.getHash();if(k!==f){f=k;c.Adapter.trigger(d,"hashchange")}return true}}setInterval(b.checkerFunction,c.options.hashChangeCheckerDelay);return true})}if(c.emulated.pushState){b.onHashChange=function(g){c.debug("_History.onHashChange",this,arguments);var h=(g&&g.newURL)||a.location.href;currentHash=unescape(c.extractHashFromUrl(h)),currentState=null,currentStateHash=null,currentStateHashExits=null;if(b.isLastHash(currentHash)){c.debug("_History.onHashChange: no change");c.busy(false);return false}b.saveHash(currentHash);currentState=c.expandHash(currentHash);if(!currentState){c.debug("_History.onHashChange: traditional anchor");c.Adapter.trigger(d,"anchorchange");c.busy(false);return false}if(b.isLastState(currentState)){c.debug("_History.onHashChange: no change");c.busy(false);return false}currentStateHash=c.contractState(currentState);c.debug("_History.onHashChange: ","currentStateHash",currentStateHash,"Hash -1",b.getHashByIndex(-1),"Hash -2",b.getHashByIndex(-2),"Hash -3",b.getHashByIndex(-3),"Hash -4",b.getHashByIndex(-4),"Hash -5",b.getHashByIndex(-5),"Hash -6",b.getHashByIndex(-6),"Hash -7",b.getHashByIndex(-7));var f=b.discardedState(currentState);if(f){c.debug("forwardState:",c.contractState(f.forwardState),"backState:",c.contractState(f.backState));if(b.getHashByIndex(-2)===c.contractState(f.forwardState)){c.debug("_History.onHashChange: go backwards");c.back(false)}else{c.debug("_History.onHashChange: go forwards");c.forward(false)}c.busy(false);return false}c.debug("_History.onHashChange: success hashchange");c.pushState(currentState.data,currentState.title,currentState.url,false);return true};c.Adapter.bind(d,"hashchange",b.onHashChange);c.pushState=function(k,o,f,m){c.debug("History.pushState",this,arguments);if(c.extractHashFromUrl(f)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(m!==false&&c.busy()){c.debug("History.pushState: we must wait",arguments);c.pushQueue({scope:c,callback:c.pushState,args:arguments,queue:m});return false}c.busy(true);var j=c.createStateObject(k,o,f),g=c.contractState(j),h=c.getState(),l=c.getStateHash(),n=unescape(c.getHash());b.storeState(j);b.recycleState(j);if(a.title!==j.title){a.title=j.title;try{a.getElementsByTagName("title")[0].innerHTML=j.title}catch(i){}}c.debug("History.pushState: details","newStateHash:",g,"oldStateHash:",l,"html4Hash:",n);if(g===l){c.debug("History.pushState: no change",g);return false}if(g!==n){c.debug("History.pushState: update hash",g);c.setHash(g,false);return false}b.saveState(j);c.debug("History.pushState: trigger popstate");c.Adapter.trigger(d,"statechange");c.busy(false);return true};c.replaceState=function(j,l,i,f){c.debug("History.replaceState",this,arguments);if(c.extractHashFromUrl(i)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(f!==false&&c.busy()){c.debug("History.replaceState: we must wait",arguments);c.pushQueue({scope:c,callback:c.replaceState,args:arguments,queue:f});return false}c.busy(true);var k=c.createStateObject(j,l,i),h=c.getState(),g=b.getStateByIndex(-2);b.discardState(h,k,g);c.pushState(k.data,k.title,k.url,false);return true};if(!a.location.hash||a.location.hash==="#"){c.Adapter.onDomLoad(function(){c.debug("Internet Explorer Initial State Change Fix");var f=c.createStateObject({},"",a.location.href);c.pushState(f.data,f.title,f.url)})}else{if(!c.emulated.hashChange){c.debug("Firefox Initial State Change Fix");c.Adapter.onDomLoad(function(){b.onHashChange()})}}}};c.initHtml4()})(window);